@model Demo.Models.Department
@{
    ViewBag.Title = "StaffSync | Departments";
    var departments = ViewBag.Departments as IEnumerable<Demo.Models.Department>;
}

<h1>Department Management</h1>

@if (TempData["Info"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Info"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form asp-action="Index" method="post" class="form mb-4">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    <div class="mb-3">
        <label asp-for="Name" class="form-label">Department Name</label>
        <input asp-for="Name" class="form-control" autofocus />
        <span asp-validation-for="Name" class="text-danger"></span>
    </div>
    <button type="submit" class="btn btn-primary">Insert</button>
    <button type="reset" class="btn btn-secondary">Reset</button>
</form>

<div class="d-flex justify-content-between align-items-center mb-3">
    <p class="mb-0">@departments?.Count() Department(s)</p>
    @if (departments?.Any() == true)
    {
        <small class="text-muted">Click on a department name to view details</small>
    }
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Department Name</th>
                <th class="text-center">Employees</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var dept in departments ?? Enumerable.Empty<Demo.Models.Department>())
            {
                var employeeCount = ViewContext.HttpContext.RequestServices
                .GetService<Demo.Models.DB>()?.Employees
                .Count(e => e.DepartmentId == dept.Id) ?? 0;

                <tr>
                    <td><strong>@dept.Id</strong></td>
                    <td>
                        <a asp-action="Details" asp-route-id="@dept.Id"
                           class="text-decoration-none fw-bold text-primary">
                            @dept.Name
                        </a>
                        @if (employeeCount > 0)
                        {
                            <br>
                    
                            <small class="text-muted">@employeeCount employee(s)</small>
                        }
                    </td>
                    <td class="text-center">
                        @if (employeeCount > 0)
                        {
                            <span class="badge bg-info">@employeeCount</span>
                        }
                        else
                        {
                            <span class="text-muted">0</span>
                        }
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <a asp-action="Details" asp-route-id="@dept.Id"
                               class="btn btn-outline-info" title="View Details">
                                <i class="fas fa-eye"></i> Details
                            </a>
                            <button data-post="/Department/Delete/@dept.Id"
                                    class="btn btn-outline-danger"
                                    title="Delete Department"
                                    @(employeeCount > 0 ? "disabled" : "")>
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (departments?.Any() != true)
{
    <div class="text-center py-5">
        <i class="fas fa-building fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No departments found</h5>
        <p class="text-muted">Create your first department using the form above.</p>
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
    <script>
        document.querySelectorAll('[data-post]').forEach(button => {
            button.addEventListener('click', () => {
                const departmentName = button.closest('tr').querySelector('a').textContent.trim();
                if (confirm(`Are you sure you want to delete the department "${departmentName}"?`)) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = button.getAttribute('data-post');
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    form.innerHTML = `<input type="hidden" name="__RequestVerificationToken" value="${token}" />`;
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });

        // Add hover effect for department links
        document.querySelectorAll('a[asp-action="Details"]').forEach(link => {
            link.addEventListener('mouseenter', function() {
                this.classList.add('text-decoration-underline');
            });
            link.addEventListener('mouseleave', function() {
                this.classList.remove('text-decoration-underline');
            });
        });
    </script>
}